<!DOCTYPE html>
<!-- saved from url=(0058)https://docs.pycom.io/tutorials/lora/lorawan-nano-gateway/ -->
<html class="fancyScroll"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link href="./LoRaWAN Nano-Gateway_files/css" rel="stylesheet">
  
  <link href="./LoRaWAN Nano-Gateway_files/vuetify.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <title>LoRaWAN Nano-Gateway </title>
  <meta name="description" content="">

  <script async="" src="./LoRaWAN Nano-Gateway_files/analytics.js"></script><script type="text/javascript" async="" src="./LoRaWAN Nano-Gateway_files/atrk.js"></script><script src="./LoRaWAN Nano-Gateway_files/smooth-scroll.js"></script><style>@media print {#ghostery-purple-box {display:none !important}}</style>
  <link href="./LoRaWAN Nano-Gateway_files/doc-theme.css" rel="stylesheet">
  <link rel="icon" href="https://docs.pycom.io/favicon.ico">
  
  <link rel="stylesheet" href="./LoRaWAN Nano-Gateway_files/docsearch.min.css">
<script async="" src="./LoRaWAN Nano-Gateway_files/hotjar-1216663.js"></script><script async="" src="./LoRaWAN Nano-Gateway_files/modules.854148dc4c0cbcfc705f.js" charset="utf-8"></script><style type="text/css">iframe#_hjRemoteVarsFrame {display: none !important; width: 1px !important; height: 1px !important; opacity: 0 !important; pointer-events: none !important;}</style></head>
<body>

<div data-app="true" class="application theme--light" id="app" style="background-color: white;"><div class="application--wrap"><aside class="lighten-4 pt-0 v-navigation-drawer v-navigation-drawer--fixed v-navigation-drawer--open theme--light" data-booted="true" style="height: 100%; margin-top: 68px; max-height: calc(100% - 0px); transform: translateX(0px); width: 300px; overflow: hidden;"><div class="fancyScroll pa-0 ma-0" style="overflow: hidden scroll; max-height: 100%;"><hr class="mr-2 ml-1 mb-4 v-divider theme--light" style="border: 0px;"> <ul class="lefttree"><li class="lefttree"><a href="https://docs.pycom.io/" class="beba" style="color: rgb(30, 30, 60); text-decoration: none;"><i aria-hidden="true" class="v-icon mr-1 material-icons theme--light" style="color: rgb(30, 30, 60);">home</i> Introduction</a></li></ul> <ul class="lefttree "><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/products/">Pycom Products</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/gettingstarted/">  Getting Started</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/pymakr/installation/">  Pymakr</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/pytrackpysense/">  Pytrack, Pysense, Pyscan</a></li><li class="lefttree padleft hot"><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/" class="hot">  Tutorials &amp; Examples</a> <ul class="lefttree "><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/all/">  All Pycom Device Examples</a></li><li class="lefttree padleft hot"><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/" class="hot">  LoRa Examples</a> <ul class="lefttree "><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/lora-mac/">LoRa-MAC (Raw LoRa)</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/lorawan-otaa/">LoRaWAN with OTAA</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/lorawan-abp/">LoRaWAN with ABP</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/lora-mac-nano-gateway/">LoRa-MAC Nano-Gateway</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/module-module/">LoPy to LoPy</a></li> <li class="lefttree hot"><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/lorawan-nano-gateway/" class="hot">LoRaWAN Nano-Gateway</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lora/rn2483-to-lopy/">RN2483 to LoPy</a></li></ul></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/sigfox/">Sigfox Examples</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/lte/">  LTE Examples</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/pytrack/">Pytrack Examples</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/pysense/">Pysense Examples</a></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/tutorials/pyscan/">Pyscan Examples</a></li></ul></li> <li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/firmwareapi/">  Firmware &amp; API Reference</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/datasheets/">  Product Info, Datasheets</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/pybytes/">  Pybytes</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/pymesh/">  Pymesh</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/docnotes/">  Documentation Notes</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/advance/downgrade/">  Advanced topics</a></li><li class="lefttree "><i aria-hidden="true" class="v-icon material-icons theme--light" style="color: transparent;">done</i> <a href="https://docs.pycom.io/documents/">documents</a></li></ul> <hr class="grey lighten-1 ma-2 mt-4 mb-4 v-divider theme--light"> <ul class="lefttree">Have a question ?
      <li class="lefttree"><a href="https://forum.pycom.io/">Ask on the forum</a></li></ul> <p>&nbsp;</p> <p>&nbsp;</p></div><div class="v-navigation-drawer__border"></div></aside> <nav class="pr-3 pl-2 navbar v-toolbar elevation-0 v-toolbar--fixed theme--dark" data-booted="true" style="margin-top: 0px; padding-right: 0px; padding-left: 300px; transform: translateY(0px); background-color: rgb(23, 23, 48);"><div class="v-toolbar__content" style="height: 68px;"><div class="v-toolbar__title ml-4 pl-0  pt-2 text-xs-center hidden-sm-and-down" style="width: 260px;"><div class="v-responsive v-image ml-4" style="height: 48px; width: 190px;"><div class="v-responsive__sizer" style="padding-bottom: 24.6667%;"></div><div class="v-image__image v-image__image--cover" style="background-image: url(&quot;https://docs.pycom.io/logo.svg&quot;); background-position: center center;"></div><div class="v-responsive__content"></div></div></div> <button type="button" class="v-btn v-btn--icon theme--dark" style="z-index: 1200;"><div class="v-btn__content"><i aria-hidden="true" class="v-icon material-icons theme--dark">toc</i></div></button> <span class="beba" style="font-size: 1.6rem; opacity: 0.85;">
        LoRaWAN Nano-Gateway
    </span> <div class="v-input ml-3 algolia-search-field v-text-field v-text-field--single-line v-text-field--solo v-text-field--enclosed v-input--hide-details theme--light" style="max-width: 650px;"><div class="v-input__control"><div class="v-input__slot"><div class="v-text-field__slot"><label aria-hidden="true" class="v-label theme--light" style="left: 0px; right: auto; position: absolute;">Search the docs...</label><span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input aria-label="Search the docs..." type="text" class="ds-input" autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: &quot;Space Mono&quot;; font-size: 16px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;"><div class="ds-dataset-1"></div></span></span></div><div class="v-input__append-inner"><div class="v-input__icon v-input__icon--append"><i aria-hidden="true" class="v-icon material-icons theme--light">search</i></div></div></div></div></div> <div class="spacer"></div> <button type="button" class="v-btn v-btn--icon theme--dark"><div class="v-btn__content"><i aria-hidden="true" class="v-icon material-icons theme--dark" style="color: rgb(23, 255, 189);">more_vert</i></div></button></div></nav> <main class="v-content" data-booted="true" style="padding: 68px 0px 0px 300px;"><div class="v-content__wrap"><div class="container fluid pa-4" style="padding-top: 0px !important;"><div class="container ma-1 pa-1"><!----> <div class="DocSearch-content v-card v-card--flat v-sheet theme--light"><div class="v-card__text"><a href="https://docs.pycom.io/tutorials/" class="bread hot">  Tutorials &amp; Examples</a>
        &gt;
      
        








  
  

  

  
      
        








  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  




    

  






  
  

  

  
      

      <a href="https://docs.pycom.io/tutorials/lora/" class="bread hot">  LoRa Examples</a>
        &gt;
      
        








  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      

  
  






  
  

  

  
    

      <a href="https://docs.pycom.io/tutorials/lora/lorawan-nano-gateway/" class="bread">LoRaWAN Nano-Gateway </a> <h1 class="mt-0 pt-0">LoRaWAN Nano-Gateway</h1> <h1 id="lorawan-nano-gateway">LoRaWAN Nano-Gateway</h1> <p>This example allows to connect a LoPy to a LoRaWAN network such as The Things Network (TTN) or Loriot to be used as a nano-gateway.</p> <p>This example uses settings specifically for connecting to The Things Network within the European 868 MHz region. For another usage, please see the <code>config.py</code> file for relevant sections that need changing.</p> <p>Up to date versions of these snippets can be found at the following <a href="https://github.com/pycom/pycom-libraries/tree/master/examples/lorawan-nano-gateway">GitHub Repository</a>. For more information and discussion about this code, see this forum <a href="https://forum.pycom.io/topic/810/new-firmware-release-1-6-7-b1-lorawan-nano-gateway-with-ttn-example">post</a>.</p> <h2 id="nano-gateway">Nano-Gateway</h2> <p>The Nano-Gateway code is split into 3 files, <code>main.py</code>, <code>config.py</code> and <code>nanogateway.py</code>. These are used to configure and specify how the gateway will connect to a preferred network and how it can act as packet forwarder.</p> <h3 id="gateway-id">Gateway ID</h3> <p>Most LoRaWAN network servers expect a Gateway ID in the form of a unique 64-bit hexadecimal number (called a EUI-64). The recommended practice is to produce this ID from your board by expanding the WiFi MAC address (a 48-bit number, called MAC-48). You can obtain that by running this code prior to configuration:</p> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">network</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> WLAN
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">ubinascii</span>
wl <span style="color: rgb(102, 102, 102);">=</span> WLAN()
ubinascii<span style="color: rgb(102, 102, 102);">.</span>hexlify(wl<span style="color: rgb(102, 102, 102);">.</span>mac())[:<span style="color: rgb(64, 160, 112);">6</span>] <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(64, 112, 160);">'FFFE'</span> <span style="color: rgb(102, 102, 102);">+</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>hexlify(wl<span style="color: rgb(102, 102, 102);">.</span>mac())[<span style="color: rgb(64, 160, 112);">6</span>:]</code></pre></div> <p>The result will by something like <code>b'240ac4FFFE008d88'</code> where <code>240ac4FFFE008d88</code> is your Gateway ID to be used in your network provider configuration.</p> <h2 id="main-main-py">Main (<code>main.py</code>)</h2> <p>This file runs at boot and calls the library and <code>config.py</code> files to initialise the nano-gateway. Once configuration is set, the nano-gateway is then started.</p> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(64, 112, 160);">""" LoPy LoRaWAN Nano Gateway example usage """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">config</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">nanogateway</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> NanoGateway

<span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> __name__ <span style="color: rgb(102, 102, 102);">==</span> <span style="color: rgb(64, 112, 160);">'__main__'</span>:
    nanogw <span style="color: rgb(102, 102, 102);">=</span> NanoGateway(
        <span style="color: rgb(0, 112, 32);">id</span><span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>GATEWAY_ID,
        frequency<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>LORA_FREQUENCY,
        datarate<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>LORA_GW_DR,
        ssid<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>WIFI_SSID,
        password<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>WIFI_PASS,
        server<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>SERVER,
        port<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>PORT,
        ntp_server<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>NTP,
        ntp_period<span style="color: rgb(102, 102, 102);">=</span>config<span style="color: rgb(102, 102, 102);">.</span>NTP_PERIOD_S
        )

    nanogw<span style="color: rgb(102, 102, 102);">.</span>start()
    nanogw<span style="color: rgb(102, 102, 102);">.</span>_log(<span style="color: rgb(64, 112, 160);">'You may now press ENTER to enter the REPL'</span>)
    <span style="color: rgb(0, 112, 32);">input</span>()</code></pre></div> <h2 id="configuration-config-py">Configuration (<code>config.py</code>)</h2> <p>This file contains settings for the server and network it is connecting to. Depending on the nano-gateway region and provider (TTN, Loriot, etc.) these will vary. The provided example will work with The Things Network (TTN) in the European, 868Mhz, region.</p> <p>The Gateway ID is generated in the script using the process described above.</p> <p><strong>Please change the WIFI_SSID and WIFI_PASS variables to match your desired WiFi network</strong></p> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(64, 112, 160);">""" LoPy LoRaWAN Nano Gateway configuration options """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">machine</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">ubinascii</span>

WIFI_MAC <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>hexlify(machine<span style="color: rgb(102, 102, 102);">.</span>unique_id())<span style="color: rgb(102, 102, 102);">.</span>upper()
<span style="color: rgb(96, 160, 176); font-style: italic;"># Set  the Gateway ID to be the first 3 bytes of MAC address + 'FFFE' + last 3 bytes of MAC address</span>
GATEWAY_ID <span style="color: rgb(102, 102, 102);">=</span> WIFI_MAC[:<span style="color: rgb(64, 160, 112);">6</span>] <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(64, 112, 160);">"FFFE"</span> <span style="color: rgb(102, 102, 102);">+</span> WIFI_MAC[<span style="color: rgb(64, 160, 112);">6</span>:<span style="color: rgb(64, 160, 112);">12</span>]

SERVER <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">'router.eu.thethings.network'</span>
PORT <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">1700</span>

NTP <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"pool.ntp.org"</span>
NTP_PERIOD_S <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">3600</span>

WIFI_SSID <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">'my-wifi'</span>
WIFI_PASS <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">'my-wifi-password'</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># for EU868</span>
LORA_FREQUENCY <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">868100000</span>
LORA_GW_DR <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"SF7BW125"</span> <span style="color: rgb(96, 160, 176); font-style: italic;"># DR_5</span>
LORA_NODE_DR <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">5</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># for US915</span>
<span style="color: rgb(96, 160, 176); font-style: italic;"># LORA_FREQUENCY = 903900000</span>
<span style="color: rgb(96, 160, 176); font-style: italic;"># LORA_GW_DR = "SF7BW125" # DR_3</span>
<span style="color: rgb(96, 160, 176); font-style: italic;"># LORA_NODE_DR = 3</span></code></pre></div> <h2 id="library-nanogateway-py">Library (<code>nanogateway.py</code>)</h2> <p>The nano-gateway library controls all of the packet generation and forwarding for the LoRa data. This does not require any user configuration and the latest version of this code should be downloaded from the Pycom <a href="https://github.com/pycom/pycom-libraries/tree/master/examples/lorawan-nano-gateway">GitHub Repository</a>.</p> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(64, 112, 160);">""" LoPy Nano Gateway class """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">network</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> WLAN
<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">network</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> LoRa
<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">machine</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> Timer
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">os</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">ubinascii</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">machine</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">json</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">time</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">errno</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">_thread</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">socket</span>


PROTOCOL_VERSION <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">2</span>)

PUSH_DATA <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">0</span>)
PUSH_ACK <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">1</span>)
PULL_DATA <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">2</span>)
PULL_ACK <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">4</span>)
PULL_RESP <span style="color: rgb(102, 102, 102);">=</span> const(<span style="color: rgb(64, 160, 112);">3</span>)

TX_ERR_NONE <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"NONE"</span>
TX_ERR_TOO_LATE <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"TOO_LATE"</span>
TX_ERR_TOO_EARLY <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"TOO_EARLY"</span>
TX_ERR_COLLISION_PACKET <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"COLLISION_PACKET"</span>
TX_ERR_COLLISION_BEACON <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"COLLISION_BEACON"</span>
TX_ERR_TX_FREQ <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"TX_FREQ"</span>
TX_ERR_TX_POWER <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"TX_POWER"</span>
TX_ERR_GPS_UNLOCKED <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"GPS_UNLOCKED"</span>

STAT_PK <span style="color: rgb(102, 102, 102);">=</span> {<span style="color: rgb(64, 112, 160);">"stat"</span>: {<span style="color: rgb(64, 112, 160);">"time"</span>: <span style="color: rgb(64, 112, 160);">""</span>, <span style="color: rgb(64, 112, 160);">"lati"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                   <span style="color: rgb(64, 112, 160);">"long"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"alti"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                   <span style="color: rgb(64, 112, 160);">"rxnb"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"rxok"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                   <span style="color: rgb(64, 112, 160);">"rxfw"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"ackr"</span>: <span style="color: rgb(64, 160, 112);">100.0</span>,
                   <span style="color: rgb(64, 112, 160);">"dwnb"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"txnb"</span>: <span style="color: rgb(64, 160, 112);">0</span>}}

RX_PK <span style="color: rgb(102, 102, 102);">=</span> {<span style="color: rgb(64, 112, 160);">"rxpk"</span>: [{<span style="color: rgb(64, 112, 160);">"time"</span>: <span style="color: rgb(64, 112, 160);">""</span>, <span style="color: rgb(64, 112, 160);">"tmst"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                  <span style="color: rgb(64, 112, 160);">"chan"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"rfch"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                  <span style="color: rgb(64, 112, 160);">"freq"</span>: <span style="color: rgb(64, 160, 112);">868.1</span>, <span style="color: rgb(64, 112, 160);">"stat"</span>: <span style="color: rgb(64, 160, 112);">1</span>,
                  <span style="color: rgb(64, 112, 160);">"modu"</span>: <span style="color: rgb(64, 112, 160);">"LORA"</span>, <span style="color: rgb(64, 112, 160);">"datr"</span>: <span style="color: rgb(64, 112, 160);">"SF7BW125"</span>,
                  <span style="color: rgb(64, 112, 160);">"codr"</span>: <span style="color: rgb(64, 112, 160);">"4/5"</span>, <span style="color: rgb(64, 112, 160);">"rssi"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                  <span style="color: rgb(64, 112, 160);">"lsnr"</span>: <span style="color: rgb(64, 160, 112);">0</span>, <span style="color: rgb(64, 112, 160);">"size"</span>: <span style="color: rgb(64, 160, 112);">0</span>,
                  <span style="color: rgb(64, 112, 160);">"data"</span>: <span style="color: rgb(64, 112, 160);">""</span>}]}

TX_ACK_PK <span style="color: rgb(102, 102, 102);">=</span> {<span style="color: rgb(64, 112, 160);">"txpk_ack"</span>:{<span style="color: rgb(64, 112, 160);">"error"</span>:<span style="color: rgb(64, 112, 160);">""</span>}}


<span style="color: rgb(0, 112, 32); font-weight: bold;">class</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">NanoGateway</span>:

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> __init__(self, <span style="color: rgb(0, 112, 32);">id</span>, frequency, datarate, ssid, password, server, port, ntp<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 112, 160);">'pool.ntp.org'</span>, ntp_period<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">3600</span>):
            self<span style="color: rgb(102, 102, 102);">.</span><span style="color: rgb(0, 112, 32);">id</span> <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">id</span>
        self<span style="color: rgb(102, 102, 102);">.</span>frequency <span style="color: rgb(102, 102, 102);">=</span> frequency
        self<span style="color: rgb(102, 102, 102);">.</span>sf <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>_dr_to_sf(datarate)
        self<span style="color: rgb(102, 102, 102);">.</span>ssid <span style="color: rgb(102, 102, 102);">=</span> ssid
        self<span style="color: rgb(102, 102, 102);">.</span>password <span style="color: rgb(102, 102, 102);">=</span> password
        self<span style="color: rgb(102, 102, 102);">.</span>server <span style="color: rgb(102, 102, 102);">=</span> server
        self<span style="color: rgb(102, 102, 102);">.</span>port <span style="color: rgb(102, 102, 102);">=</span> port
        self<span style="color: rgb(102, 102, 102);">.</span>ntp <span style="color: rgb(102, 102, 102);">=</span> ntp
        self<span style="color: rgb(102, 102, 102);">.</span>ntp_period <span style="color: rgb(102, 102, 102);">=</span> ntp_period

        self<span style="color: rgb(102, 102, 102);">.</span>rxnb <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">0</span>
        self<span style="color: rgb(102, 102, 102);">.</span>rxok <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">0</span>
                self<span style="color: rgb(102, 102, 102);">.</span>rxfw <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">0</span>
                self<span style="color: rgb(102, 102, 102);">.</span>dwnb <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">0</span>
                self<span style="color: rgb(102, 102, 102);">.</span>txnb <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 160, 112);">0</span>

        self<span style="color: rgb(102, 102, 102);">.</span>stat_alarm <span style="color: rgb(102, 102, 102);">=</span> None
                self<span style="color: rgb(102, 102, 102);">.</span>pull_alarm <span style="color: rgb(102, 102, 102);">=</span> None
                self<span style="color: rgb(102, 102, 102);">.</span>uplink_alarm <span style="color: rgb(102, 102, 102);">=</span> None

        self<span style="color: rgb(102, 102, 102);">.</span>udp_lock <span style="color: rgb(102, 102, 102);">=</span> _thread<span style="color: rgb(102, 102, 102);">.</span>allocate_lock()

        self<span style="color: rgb(102, 102, 102);">.</span>lora <span style="color: rgb(102, 102, 102);">=</span> None
        self<span style="color: rgb(102, 102, 102);">.</span>lora_sock <span style="color: rgb(102, 102, 102);">=</span> None

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">start</span>(self):
        <span style="color: rgb(96, 160, 176); font-style: italic;"># Change WiFi to STA mode and connect</span>
        self<span style="color: rgb(102, 102, 102);">.</span>wlan <span style="color: rgb(102, 102, 102);">=</span> WLAN(mode<span style="color: rgb(102, 102, 102);">=</span>WLAN<span style="color: rgb(102, 102, 102);">.</span>STA)
        self<span style="color: rgb(102, 102, 102);">.</span>_connect_to_wifi()

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Get a time Sync</span>
        self<span style="color: rgb(102, 102, 102);">.</span>rtc <span style="color: rgb(102, 102, 102);">=</span> machine<span style="color: rgb(102, 102, 102);">.</span>RTC()
        self<span style="color: rgb(102, 102, 102);">.</span>rtc<span style="color: rgb(102, 102, 102);">.</span>ntp_sync(self<span style="color: rgb(102, 102, 102);">.</span>ntp, update_period<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>ntp_period)

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Get the server IP and create an UDP socket</span>
        self<span style="color: rgb(102, 102, 102);">.</span>server_ip <span style="color: rgb(102, 102, 102);">=</span> socket<span style="color: rgb(102, 102, 102);">.</span>getaddrinfo(self<span style="color: rgb(102, 102, 102);">.</span>server, self<span style="color: rgb(102, 102, 102);">.</span>port)[<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(102, 102, 102);">-</span><span style="color: rgb(64, 160, 112);">1</span>]
        self<span style="color: rgb(102, 102, 102);">.</span>sock <span style="color: rgb(102, 102, 102);">=</span> socket<span style="color: rgb(102, 102, 102);">.</span>socket(socket<span style="color: rgb(102, 102, 102);">.</span>AF_INET, socket<span style="color: rgb(102, 102, 102);">.</span>SOCK_DGRAM, socket<span style="color: rgb(102, 102, 102);">.</span>IPPROTO_UDP)
        self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>setsockopt(socket<span style="color: rgb(102, 102, 102);">.</span>SOL_SOCKET, socket<span style="color: rgb(102, 102, 102);">.</span>SO_REUSEADDR, <span style="color: rgb(64, 160, 112);">1</span>)
        self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>setblocking(False)

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Push the first time immediately</span>
        self<span style="color: rgb(102, 102, 102);">.</span>_push_data(self<span style="color: rgb(102, 102, 102);">.</span>_make_stat_packet())

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Create the alarms</span>
        self<span style="color: rgb(102, 102, 102);">.</span>stat_alarm <span style="color: rgb(102, 102, 102);">=</span> Timer<span style="color: rgb(102, 102, 102);">.</span>Alarm(handler<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(0, 112, 32); font-weight: bold;">lambda</span> t: self<span style="color: rgb(102, 102, 102);">.</span>_push_data(self<span style="color: rgb(102, 102, 102);">.</span>_make_stat_packet()), s<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">60</span>, periodic<span style="color: rgb(102, 102, 102);">=</span>True)
        self<span style="color: rgb(102, 102, 102);">.</span>pull_alarm <span style="color: rgb(102, 102, 102);">=</span> Timer<span style="color: rgb(102, 102, 102);">.</span>Alarm(handler<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(0, 112, 32); font-weight: bold;">lambda</span> u: self<span style="color: rgb(102, 102, 102);">.</span>_pull_data(), s<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">25</span>, periodic<span style="color: rgb(102, 102, 102);">=</span>True)

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Start the UDP receive thread</span>
        _thread<span style="color: rgb(102, 102, 102);">.</span>start_new_thread(self<span style="color: rgb(102, 102, 102);">.</span>_udp_thread, ())

        <span style="color: rgb(96, 160, 176); font-style: italic;"># Initialize LoRa in LORA mode</span>
        self<span style="color: rgb(102, 102, 102);">.</span>lora <span style="color: rgb(102, 102, 102);">=</span> LoRa(mode<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>LORA, frequency<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>frequency, bandwidth<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>BW_125KHZ, sf<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>sf,
                        preamble<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">8</span>, coding_rate<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>CODING_4_5, tx_iq<span style="color: rgb(102, 102, 102);">=</span>True)
        <span style="color: rgb(96, 160, 176); font-style: italic;"># Create a raw LoRa socket</span>
        self<span style="color: rgb(102, 102, 102);">.</span>lora_sock <span style="color: rgb(102, 102, 102);">=</span> socket<span style="color: rgb(102, 102, 102);">.</span>socket(socket<span style="color: rgb(102, 102, 102);">.</span>AF_LORA, socket<span style="color: rgb(102, 102, 102);">.</span>SOCK_RAW)
        self<span style="color: rgb(102, 102, 102);">.</span>lora_sock<span style="color: rgb(102, 102, 102);">.</span>setblocking(False)
        self<span style="color: rgb(102, 102, 102);">.</span>lora_tx_done <span style="color: rgb(102, 102, 102);">=</span> False

        self<span style="color: rgb(102, 102, 102);">.</span>lora<span style="color: rgb(102, 102, 102);">.</span>callback(trigger<span style="color: rgb(102, 102, 102);">=</span>(LoRa<span style="color: rgb(102, 102, 102);">.</span>RX_PACKET_EVENT <span style="color: rgb(102, 102, 102);">|</span> LoRa<span style="color: rgb(102, 102, 102);">.</span>TX_PACKET_EVENT), handler<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>_lora_cb)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">stop</span>(self):
        <span style="color: rgb(96, 160, 176); font-style: italic;"># TODO: Check how to stop the NTP sync</span>
        <span style="color: rgb(96, 160, 176); font-style: italic;"># TODO: Create a cancel method for the alarm</span>
        <span style="color: rgb(96, 160, 176); font-style: italic;"># TODO: kill the UDP thread</span>
        self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>close()

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_connect_to_wifi</span>(self):
        self<span style="color: rgb(102, 102, 102);">.</span>wlan<span style="color: rgb(102, 102, 102);">.</span>connect(self<span style="color: rgb(102, 102, 102);">.</span>ssid, auth<span style="color: rgb(102, 102, 102);">=</span>(None, self<span style="color: rgb(102, 102, 102);">.</span>password))
        <span style="color: rgb(0, 112, 32); font-weight: bold;">while</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">not</span> self<span style="color: rgb(102, 102, 102);">.</span>wlan<span style="color: rgb(102, 102, 102);">.</span>isconnected():
            time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">0.5</span>)
        <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"WiFi connected!"</span>)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_dr_to_sf</span>(self, dr):
        sf <span style="color: rgb(102, 102, 102);">=</span> dr[<span style="color: rgb(64, 160, 112);">2</span>:<span style="color: rgb(64, 160, 112);">4</span>]
        <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> sf[<span style="color: rgb(64, 160, 112);">1</span>] <span style="color: rgb(0, 112, 32); font-weight: bold;">not</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">in</span> <span style="color: rgb(64, 112, 160);">'0123456789'</span>:
            sf <span style="color: rgb(102, 102, 102);">=</span> sf[:<span style="color: rgb(64, 160, 112);">1</span>]
        <span style="color: rgb(0, 112, 32); font-weight: bold;">return</span> <span style="color: rgb(0, 112, 32);">int</span>(sf)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_sf_to_dr</span>(self, sf):
        <span style="color: rgb(0, 112, 32); font-weight: bold;">return</span> <span style="color: rgb(64, 112, 160);">"SF7BW125"</span>

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_make_stat_packet</span>(self):
        now <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>rtc<span style="color: rgb(102, 102, 102);">.</span>now()
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"time"</span>] <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"</span><span style="color: rgb(112, 160, 208); font-style: italic;">%d</span><span style="color: rgb(64, 112, 160);">-</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">-</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);"> </span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">:</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">:</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);"> GMT"</span> <span style="color: rgb(102, 102, 102);">%</span> (now[<span style="color: rgb(64, 160, 112);">0</span>], now[<span style="color: rgb(64, 160, 112);">1</span>], now[<span style="color: rgb(64, 160, 112);">2</span>], now[<span style="color: rgb(64, 160, 112);">3</span>], now[<span style="color: rgb(64, 160, 112);">4</span>], now[<span style="color: rgb(64, 160, 112);">5</span>])
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"rxnb"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>rxnb
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"rxok"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>rxok
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"rxfw"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>rxfw
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"dwnb"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>dwnb
        STAT_PK[<span style="color: rgb(64, 112, 160);">"stat"</span>][<span style="color: rgb(64, 112, 160);">"txnb"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>txnb
        <span style="color: rgb(0, 112, 32); font-weight: bold;">return</span> json<span style="color: rgb(102, 102, 102);">.</span>dumps(STAT_PK)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_make_node_packet</span>(self, rx_data, rx_time, tmst, sf, rssi, snr):
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"time"</span>] <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(64, 112, 160);">"</span><span style="color: rgb(112, 160, 208); font-style: italic;">%d</span><span style="color: rgb(64, 112, 160);">-</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">-</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">T</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">:</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">:</span><span style="color: rgb(112, 160, 208); font-style: italic;">%02d</span><span style="color: rgb(64, 112, 160);">.</span><span style="color: rgb(112, 160, 208); font-style: italic;">%d</span><span style="color: rgb(64, 112, 160);">Z"</span> <span style="color: rgb(102, 102, 102);">%</span> (rx_time[<span style="color: rgb(64, 160, 112);">0</span>], rx_time[<span style="color: rgb(64, 160, 112);">1</span>], rx_time[<span style="color: rgb(64, 160, 112);">2</span>], rx_time[<span style="color: rgb(64, 160, 112);">3</span>], rx_time[<span style="color: rgb(64, 160, 112);">4</span>], rx_time[<span style="color: rgb(64, 160, 112);">5</span>], rx_time[<span style="color: rgb(64, 160, 112);">6</span>])
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"tmst"</span>] <span style="color: rgb(102, 102, 102);">=</span> tmst
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"datr"</span>] <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>_sf_to_dr(sf)
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"rssi"</span>] <span style="color: rgb(102, 102, 102);">=</span> rssi
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"lsnr"</span>] <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">float</span>(snr)
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"data"</span>] <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>b2a_base64(rx_data)[:<span style="color: rgb(102, 102, 102);">-</span><span style="color: rgb(64, 160, 112);">1</span>]
        RX_PK[<span style="color: rgb(64, 112, 160);">"rxpk"</span>][<span style="color: rgb(64, 160, 112);">0</span>][<span style="color: rgb(64, 112, 160);">"size"</span>] <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">len</span>(rx_data)
        <span style="color: rgb(0, 112, 32); font-weight: bold;">return</span> json<span style="color: rgb(102, 102, 102);">.</span>dumps(RX_PK)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_push_data</span>(self, data):
        token <span style="color: rgb(102, 102, 102);">=</span> os<span style="color: rgb(102, 102, 102);">.</span>urandom(<span style="color: rgb(64, 160, 112);">2</span>)
        packet <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PROTOCOL_VERSION]) <span style="color: rgb(102, 102, 102);">+</span> token <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PUSH_DATA]) <span style="color: rgb(102, 102, 102);">+</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(self<span style="color: rgb(102, 102, 102);">.</span><span style="color: rgb(0, 112, 32);">id</span>) <span style="color: rgb(102, 102, 102);">+</span> data
        <span style="color: rgb(0, 112, 32); font-weight: bold;">with</span> self<span style="color: rgb(102, 102, 102);">.</span>udp_lock:
            <span style="color: rgb(0, 112, 32); font-weight: bold;">try</span>:
                self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>sendto(packet, self<span style="color: rgb(102, 102, 102);">.</span>server_ip)
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> <span style="color: rgb(0, 112, 32);">Exception</span>:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"PUSH exception"</span>)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_pull_data</span>(self):
        token <span style="color: rgb(102, 102, 102);">=</span> os<span style="color: rgb(102, 102, 102);">.</span>urandom(<span style="color: rgb(64, 160, 112);">2</span>)
        packet <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PROTOCOL_VERSION]) <span style="color: rgb(102, 102, 102);">+</span> token <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PULL_DATA]) <span style="color: rgb(102, 102, 102);">+</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(self<span style="color: rgb(102, 102, 102);">.</span><span style="color: rgb(0, 112, 32);">id</span>)
        <span style="color: rgb(0, 112, 32); font-weight: bold;">with</span> self<span style="color: rgb(102, 102, 102);">.</span>udp_lock:
            <span style="color: rgb(0, 112, 32); font-weight: bold;">try</span>:
                self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>sendto(packet, self<span style="color: rgb(102, 102, 102);">.</span>server_ip)
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> <span style="color: rgb(0, 112, 32);">Exception</span>:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"PULL exception"</span>)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_ack_pull_rsp</span>(self, token, error):
        TX_ACK_PK[<span style="color: rgb(64, 112, 160);">"txpk_ack"</span>][<span style="color: rgb(64, 112, 160);">"error"</span>] <span style="color: rgb(102, 102, 102);">=</span> error
        resp <span style="color: rgb(102, 102, 102);">=</span> json<span style="color: rgb(102, 102, 102);">.</span>dumps(TX_ACK_PK)
        packet <span style="color: rgb(102, 102, 102);">=</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PROTOCOL_VERSION]) <span style="color: rgb(102, 102, 102);">+</span> token <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(0, 112, 32);">bytes</span>([PULL_ACK]) <span style="color: rgb(102, 102, 102);">+</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(self<span style="color: rgb(102, 102, 102);">.</span><span style="color: rgb(0, 112, 32);">id</span>) <span style="color: rgb(102, 102, 102);">+</span> resp
        <span style="color: rgb(0, 112, 32); font-weight: bold;">with</span> self<span style="color: rgb(102, 102, 102);">.</span>udp_lock:
            <span style="color: rgb(0, 112, 32); font-weight: bold;">try</span>:
                self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>sendto(packet, self<span style="color: rgb(102, 102, 102);">.</span>server_ip)
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> <span style="color: rgb(0, 112, 32);">Exception</span>:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"PULL RSP ACK exception"</span>)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_lora_cb</span>(self, lora):
        events <span style="color: rgb(102, 102, 102);">=</span> lora<span style="color: rgb(102, 102, 102);">.</span>events()
        <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> events <span style="color: rgb(102, 102, 102);">&amp;</span> LoRa<span style="color: rgb(102, 102, 102);">.</span>RX_PACKET_EVENT:
            self<span style="color: rgb(102, 102, 102);">.</span>rxnb <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">1</span>
            self<span style="color: rgb(102, 102, 102);">.</span>rxok <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">1</span>
            rx_data <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>lora_sock<span style="color: rgb(102, 102, 102);">.</span>recv(<span style="color: rgb(64, 160, 112);">256</span>)
            stats <span style="color: rgb(102, 102, 102);">=</span> lora<span style="color: rgb(102, 102, 102);">.</span>stats()
            self<span style="color: rgb(102, 102, 102);">.</span>_push_data(self<span style="color: rgb(102, 102, 102);">.</span>_make_node_packet(rx_data, self<span style="color: rgb(102, 102, 102);">.</span>rtc<span style="color: rgb(102, 102, 102);">.</span>now(), stats<span style="color: rgb(102, 102, 102);">.</span>timestamp, stats<span style="color: rgb(102, 102, 102);">.</span>sf, stats<span style="color: rgb(102, 102, 102);">.</span>rssi, stats<span style="color: rgb(102, 102, 102);">.</span>snr))
            self<span style="color: rgb(102, 102, 102);">.</span>rxfw <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">1</span>
        <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> events <span style="color: rgb(102, 102, 102);">&amp;</span> LoRa<span style="color: rgb(102, 102, 102);">.</span>TX_PACKET_EVENT:
            self<span style="color: rgb(102, 102, 102);">.</span>txnb <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">1</span>
            lora<span style="color: rgb(102, 102, 102);">.</span>init(mode<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>LORA, frequency<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>frequency, bandwidth<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>BW_125KHZ,
                     sf<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>sf, preamble<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">8</span>, coding_rate<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>CODING_4_5, tx_iq<span style="color: rgb(102, 102, 102);">=</span>True)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_send_down_link</span>(self, data, tmst, datarate, frequency):
        self<span style="color: rgb(102, 102, 102);">.</span>lora<span style="color: rgb(102, 102, 102);">.</span>init(mode<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>LORA, frequency<span style="color: rgb(102, 102, 102);">=</span>frequency, bandwidth<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>BW_125KHZ,
                      sf<span style="color: rgb(102, 102, 102);">=</span>self<span style="color: rgb(102, 102, 102);">.</span>_dr_to_sf(datarate), preamble<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">8</span>, coding_rate<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>CODING_4_5,
                      tx_iq<span style="color: rgb(102, 102, 102);">=</span>True)
        <span style="color: rgb(0, 112, 32); font-weight: bold;">while</span> time<span style="color: rgb(102, 102, 102);">.</span>ticks_us() <span style="color: rgb(102, 102, 102);">&lt;</span> tmst:
            <span style="color: rgb(0, 112, 32); font-weight: bold;">pass</span>
        self<span style="color: rgb(102, 102, 102);">.</span>lora_sock<span style="color: rgb(102, 102, 102);">.</span>send(data)

    <span style="color: rgb(0, 112, 32); font-weight: bold;">def</span> <span style="color: rgb(6, 40, 126);">_udp_thread</span>(self):
        <span style="color: rgb(0, 112, 32); font-weight: bold;">while</span> True:
            <span style="color: rgb(0, 112, 32); font-weight: bold;">try</span>:
                data, src <span style="color: rgb(102, 102, 102);">=</span> self<span style="color: rgb(102, 102, 102);">.</span>sock<span style="color: rgb(102, 102, 102);">.</span>recvfrom(<span style="color: rgb(64, 160, 112);">1024</span>)
                _token <span style="color: rgb(102, 102, 102);">=</span> data[<span style="color: rgb(64, 160, 112);">1</span>:<span style="color: rgb(64, 160, 112);">3</span>]
                _type <span style="color: rgb(102, 102, 102);">=</span> data[<span style="color: rgb(64, 160, 112);">3</span>]
                <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> _type <span style="color: rgb(102, 102, 102);">==</span> PUSH_ACK:
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"Push ack"</span>)
                <span style="color: rgb(0, 112, 32); font-weight: bold;">elif</span> _type <span style="color: rgb(102, 102, 102);">==</span> PULL_ACK:
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"Pull ack"</span>)
                <span style="color: rgb(0, 112, 32); font-weight: bold;">elif</span> _type <span style="color: rgb(102, 102, 102);">==</span> PULL_RESP:
                    self<span style="color: rgb(102, 102, 102);">.</span>dwnb <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">1</span>
                    ack_error <span style="color: rgb(102, 102, 102);">=</span> TX_ERR_NONE
                    tx_pk <span style="color: rgb(102, 102, 102);">=</span> json<span style="color: rgb(102, 102, 102);">.</span>loads(data[<span style="color: rgb(64, 160, 112);">4</span>:])
                    tmst <span style="color: rgb(102, 102, 102);">=</span> tx_pk[<span style="color: rgb(64, 112, 160);">"txpk"</span>][<span style="color: rgb(64, 112, 160);">"tmst"</span>]
                    t_us <span style="color: rgb(102, 102, 102);">=</span> tmst <span style="color: rgb(102, 102, 102);">-</span> time<span style="color: rgb(102, 102, 102);">.</span>ticks_us() <span style="color: rgb(102, 102, 102);">-</span> <span style="color: rgb(64, 160, 112);">5000</span>
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> t_us <span style="color: rgb(102, 102, 102);">&lt;</span> <span style="color: rgb(64, 160, 112);">0</span>:
                        t_us <span style="color: rgb(102, 102, 102);">+=</span> <span style="color: rgb(64, 160, 112);">0xFFFFFFFF</span>
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> t_us <span style="color: rgb(102, 102, 102);">&lt;</span> <span style="color: rgb(64, 160, 112);">20000000</span>:
                        self<span style="color: rgb(102, 102, 102);">.</span>uplink_alarm <span style="color: rgb(102, 102, 102);">=</span> Timer<span style="color: rgb(102, 102, 102);">.</span>Alarm(handler<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(0, 112, 32); font-weight: bold;">lambda</span> x: self<span style="color: rgb(102, 102, 102);">.</span>_send_down_link(ubinascii<span style="color: rgb(102, 102, 102);">.</span>a2b_base64(tx_pk[<span style="color: rgb(64, 112, 160);">"txpk"</span>][<span style="color: rgb(64, 112, 160);">"data"</span>]),
                                                                                              tx_pk[<span style="color: rgb(64, 112, 160);">"txpk"</span>][<span style="color: rgb(64, 112, 160);">"tmst"</span>] <span style="color: rgb(102, 102, 102);">-</span> <span style="color: rgb(64, 160, 112);">10</span>, tx_pk[<span style="color: rgb(64, 112, 160);">"txpk"</span>][<span style="color: rgb(64, 112, 160);">"datr"</span>],
                                                                                              <span style="color: rgb(0, 112, 32);">int</span>(tx_pk[<span style="color: rgb(64, 112, 160);">"txpk"</span>][<span style="color: rgb(64, 112, 160);">"freq"</span>] <span style="color: rgb(102, 102, 102);">*</span> <span style="color: rgb(64, 160, 112);">1000000</span>)), us<span style="color: rgb(102, 102, 102);">=</span>t_us)
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">else</span>:
                        ack_error <span style="color: rgb(102, 102, 102);">=</span> TX_ERR_TOO_LATE
                        <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"Downlink timestamp error!, t_us:"</span>, t_us)
                    self<span style="color: rgb(102, 102, 102);">.</span>_ack_pull_rsp(_token, ack_error)
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"Pull rsp"</span>)
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> socket<span style="color: rgb(102, 102, 102);">.</span>timeout:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">pass</span>
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> <span style="color: rgb(0, 112, 32);">OSError</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">as</span> e:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> e<span style="color: rgb(102, 102, 102);">.</span>errno <span style="color: rgb(102, 102, 102);">==</span> errno<span style="color: rgb(102, 102, 102);">.</span>EAGAIN:
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">pass</span>
                <span style="color: rgb(0, 112, 32); font-weight: bold;">else</span>:
                    <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"UDP recv OSError Exception"</span>)
            <span style="color: rgb(0, 112, 32); font-weight: bold;">except</span> <span style="color: rgb(0, 112, 32);">Exception</span>:
                <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">"UDP recv Exception"</span>)
            <span style="color: rgb(96, 160, 176); font-style: italic;"># Wait before trying to receive again</span>
            time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">0.025</span>)</code></pre></div> <h2 id="registering-with-ttn">Registering with TTN</h2> <p>To set up the gateway with The Things Network (TTN), navigate to their website and create/register an account. Enter a username and an email address to verify with their platform.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-1.png" alt=""></p> <p>Once an account has been registered, the nano-gateway can then be registered. To do this, navigate to the TTN Console web page.</p> <h2 id="registering-the-gateway">Registering the Gateway</h2> <p>Inside the TTN Console, there are two options, <code>applications</code> and <code>gateways</code>. Select <code>gateways</code> and then click on <code>register gateway</code>. This will allow for the set up and registration of a new nano-gateway.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-2 (1).png" alt=""></p> <p>On the Register Gateway page, you will need to set the following settings:</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-gatewayreg-11-2017-2.jpg" alt=""> These are unique to each gateway, location and country specific frequency. Please verify that correct settings are selected otherwise the gateway will not connect to TTN.</p> <p><strong>You need to tick the Im using the legacy packet forwarder to enable the right settings.</strong> This is because the Nano-Gateway uses the de facto standard Semtech UDP protocol.</p> <table><thead><tr><th align="left">Option</th> <th align="left">Value</th></tr></thead> <tbody><tr><td align="left">Protocol</td> <td align="left">Packet Forwarder</td></tr> <tr><td align="left">Gateway EUI</td> <td align="left">User Defined (must match <code>config.py</code>)</td></tr> <tr><td align="left">Description</td> <td align="left">User Defined</td></tr> <tr><td align="left">Frequency Plan</td> <td align="left">Select Country (e.g. EU - 868 MHz)</td></tr> <tr><td align="left">Location</td> <td align="left">User Defined</td></tr> <tr><td align="left">Antenna Placement</td> <td align="left">Indoor or Outdoor</td></tr></tbody></table> <p>The Gateway EUI should match your Gateway ID from the <code>config.py</code> file. We suggest you follow the procedure described near the top of this document to create your own unique Gateway ID.</p> <p>Once these settings have been applied, click <code>Register Gateway</code>. A Gateway Overview page will appear, with the configuration settings showing. Next click on the <code>Gateway Settings</code> and configure the Router address to match that of the gateway (default: <code>router.eu.thethings.network</code>).</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-4 (1).png" alt=""></p> <p>The <code>Gateway</code> should now be configured. Next, one or more nodes can now be configured to use the nano-gateway and TTN applications may be built.</p> <h2 id="lopy-node">LoPy Node</h2> <p>There are two methods of connecting LoPy devices to the nano-gateway, Over the Air Activation (OTAA) and Activation By Personalisation (ABP). The code and instructions for registering these methods are shown below, followed by instruction for how to connect them to an application on TTN.</p> <div class="info-alert v-card v-sheet theme--light"><div class="v-card__text"><p>Its important that the following code examples (also on GitHub) are used to connect to the nano-gateway as it only supports single channel connections.</p></div></div> <h3 id="otaa-over-the-air-activation">OTAA (Over The Air Activation)</h3> <p>When the LoPy connects an application (via TTN) using OTAA, the network configuration is derived automatically during a handshake between the LoPy and network server. Note that the network keys derived using the OTAA methodology are specific to the device and are used to encrypt and verify transmissions at the network level.</p> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(64, 112, 160);">""" OTAA Node example compatible with the LoPy Nano Gateway """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">network</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> LoRa
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">socket</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">ubinascii</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">struct</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">time</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># Initialize LoRa in LORAWAN mode.</span>
lora <span style="color: rgb(102, 102, 102);">=</span> LoRa(mode<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>LORAWAN)

<span style="color: rgb(96, 160, 176); font-style: italic;"># create an OTA authentication params</span>
dev_eui <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'AABBCCDDEEFF7778'</span>) <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>
app_eui <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'70B3D57EF0003BFD'</span>) <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>
app_key <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'36AB7625FE77776881683B495300FFD6'</span>) <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># set the 3 default channels to the same frequency (must be before sending the OTAA join request)</span>
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">0</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">1</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">2</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># join a network using OTAA</span>
lora<span style="color: rgb(102, 102, 102);">.</span>join(activation<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>OTAA, auth<span style="color: rgb(102, 102, 102);">=</span>(dev_eui, app_eui, app_key), timeout<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># wait until the module has joined the network</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">while</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">not</span> lora<span style="color: rgb(102, 102, 102);">.</span>has_joined():
    time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">2.5</span>)
    <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(<span style="color: rgb(64, 112, 160);">'Not joined yet...'</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># remove all the non-default channels</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">for</span> i <span style="color: rgb(0, 112, 32); font-weight: bold;">in</span> <span style="color: rgb(0, 112, 32);">range</span>(<span style="color: rgb(64, 160, 112);">3</span>, <span style="color: rgb(64, 160, 112);">16</span>):
    lora<span style="color: rgb(102, 102, 102);">.</span>remove_channel(i)

<span style="color: rgb(96, 160, 176); font-style: italic;"># create a LoRa socket</span>
s <span style="color: rgb(102, 102, 102);">=</span> socket<span style="color: rgb(102, 102, 102);">.</span>socket(socket<span style="color: rgb(102, 102, 102);">.</span>AF_LORA, socket<span style="color: rgb(102, 102, 102);">.</span>SOCK_RAW)

<span style="color: rgb(96, 160, 176); font-style: italic;"># set the LoRaWAN data rate</span>
s<span style="color: rgb(102, 102, 102);">.</span>setsockopt(socket<span style="color: rgb(102, 102, 102);">.</span>SOL_LORA, socket<span style="color: rgb(102, 102, 102);">.</span>SO_DR, <span style="color: rgb(64, 160, 112);">5</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># make the socket non-blocking</span>
s<span style="color: rgb(102, 102, 102);">.</span>setblocking(False)

time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">5.0</span>)

<span style="color: rgb(64, 112, 160);">""" Your own code can be written below! """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">for</span> i <span style="color: rgb(0, 112, 32); font-weight: bold;">in</span> <span style="color: rgb(0, 112, 32);">range</span> (<span style="color: rgb(64, 160, 112);">200</span>):
    s<span style="color: rgb(102, 102, 102);">.</span>send(<span style="color: rgb(64, 112, 160);">b</span><span style="color: rgb(64, 112, 160);">'PKT #'</span> <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(0, 112, 32);">bytes</span>([i]))
    time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">4</span>)
    rx <span style="color: rgb(102, 102, 102);">=</span> s<span style="color: rgb(102, 102, 102);">.</span>recv(<span style="color: rgb(64, 160, 112);">256</span>)
    <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> rx:
        <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(rx)
    time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">6</span>)</code></pre></div> <h3 id="abp-activation-by-personalisation">ABP (Activation By Personalisation)</h3> <p>Using ABP join mode requires the user to define the following values and input them into both the LoPy and the TTN Application:</p> <ul><li>Device Address</li> <li>Application Session Key</li> <li>Network Session Key</li></ul> <div class="highlight"><pre style="background-color: rgb(240, 240, 240); tab-size: 4;"><code data-lang="python" class="language-python"><span style="color: rgb(64, 112, 160);">""" ABP Node example compatible with the LoPy Nano Gateway """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">from</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">network</span> <span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> LoRa
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">socket</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">ubinascii</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">struct</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">import</span> <span style="color: rgb(14, 132, 181); font-weight: bold;">time</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># Initialise LoRa in LORAWAN mode.</span>
lora <span style="color: rgb(102, 102, 102);">=</span> LoRa(mode<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>LORAWAN)

<span style="color: rgb(96, 160, 176); font-style: italic;"># create an ABP authentication params</span>
dev_addr <span style="color: rgb(102, 102, 102);">=</span> struct<span style="color: rgb(102, 102, 102);">.</span>unpack(<span style="color: rgb(64, 112, 160);">"&gt;l"</span>, ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'2601147D'</span>))[<span style="color: rgb(64, 160, 112);">0</span>] <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>
nwk_swkey <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'3C74F4F40CAE2221303BC24284FCF3AF'</span>) <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>
app_swkey <span style="color: rgb(102, 102, 102);">=</span> ubinascii<span style="color: rgb(102, 102, 102);">.</span>unhexlify(<span style="color: rgb(64, 112, 160);">'0FFA7072CC6FF69A102A0F39BEB0880F'</span>) <span style="color: rgb(96, 160, 176); font-style: italic;"># these settings can be found from TTN</span>

<span style="color: rgb(96, 160, 176); font-style: italic;"># join a network using ABP (Activation By Personalisation)</span>
lora<span style="color: rgb(102, 102, 102);">.</span>join(activation<span style="color: rgb(102, 102, 102);">=</span>LoRa<span style="color: rgb(102, 102, 102);">.</span>ABP, auth<span style="color: rgb(102, 102, 102);">=</span>(dev_addr, nwk_swkey, app_swkey))

<span style="color: rgb(96, 160, 176); font-style: italic;"># remove all the non-default channels</span>
<span style="color: rgb(0, 112, 32); font-weight: bold;">for</span> i <span style="color: rgb(0, 112, 32); font-weight: bold;">in</span> <span style="color: rgb(0, 112, 32);">range</span>(<span style="color: rgb(64, 160, 112);">3</span>, <span style="color: rgb(64, 160, 112);">16</span>):
    lora<span style="color: rgb(102, 102, 102);">.</span>remove_channel(i)

<span style="color: rgb(96, 160, 176); font-style: italic;"># set the 3 default channels to the same frequency</span>
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">0</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">1</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)
lora<span style="color: rgb(102, 102, 102);">.</span>add_channel(<span style="color: rgb(64, 160, 112);">2</span>, frequency<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">868100000</span>, dr_min<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">0</span>, dr_max<span style="color: rgb(102, 102, 102);">=</span><span style="color: rgb(64, 160, 112);">5</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># create a LoRa socket</span>
s <span style="color: rgb(102, 102, 102);">=</span> socket<span style="color: rgb(102, 102, 102);">.</span>socket(socket<span style="color: rgb(102, 102, 102);">.</span>AF_LORA, socket<span style="color: rgb(102, 102, 102);">.</span>SOCK_RAW)

<span style="color: rgb(96, 160, 176); font-style: italic;"># set the LoRaWAN data rate</span>
s<span style="color: rgb(102, 102, 102);">.</span>setsockopt(socket<span style="color: rgb(102, 102, 102);">.</span>SOL_LORA, socket<span style="color: rgb(102, 102, 102);">.</span>SO_DR, <span style="color: rgb(64, 160, 112);">5</span>)

<span style="color: rgb(96, 160, 176); font-style: italic;"># make the socket non-blocking</span>
s<span style="color: rgb(102, 102, 102);">.</span>setblocking(False)

<span style="color: rgb(64, 112, 160);">""" Your own code can be written below! """</span>

<span style="color: rgb(0, 112, 32); font-weight: bold;">for</span> i <span style="color: rgb(0, 112, 32); font-weight: bold;">in</span> <span style="color: rgb(0, 112, 32);">range</span> (<span style="color: rgb(64, 160, 112);">200</span>):
    s<span style="color: rgb(102, 102, 102);">.</span>send(<span style="color: rgb(64, 112, 160);">b</span><span style="color: rgb(64, 112, 160);">'PKT #'</span> <span style="color: rgb(102, 102, 102);">+</span> <span style="color: rgb(0, 112, 32);">bytes</span>([i]))
    time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">4</span>)
    rx <span style="color: rgb(102, 102, 102);">=</span> s<span style="color: rgb(102, 102, 102);">.</span>recv(<span style="color: rgb(64, 160, 112);">256</span>)
    <span style="color: rgb(0, 112, 32); font-weight: bold;">if</span> rx:
        <span style="color: rgb(0, 112, 32); font-weight: bold;">print</span>(rx)
    time<span style="color: rgb(102, 102, 102);">.</span>sleep(<span style="color: rgb(64, 160, 112);">6</span>)</code></pre></div> <h2 id="ttn-applications">TTN Applications</h2> <p>Now that the gateway &amp; nodes have been setup, a TTN Application can be built; i.e. what happens to the LoRa data once it is received by TTN. There are a number of different setups/systems that can be used, however the following example demonstrates the HTTP request integration.</p> <h2 id="registering-an-application">Registering an Application</h2> <p>Selecting the <code>Applications</code> tab at the top of the TTN console, will bring up a screen for registering applications. Click register and a new page, similar to the one below, will open.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-5.png" alt=""></p> <p>Enter a unique <code>Application ID</code> as well as a Description &amp; Handler Registration.</p> <p>Now the LoPy nodes must be registered to send data up to the new Application.</p> <h3 id="registering-devices-lopy">Registering Devices (LoPy)</h3> <p>To connect nodes to the nano-gateway, devices need to be added to the application. To do this, navigate to the <code>Devices</code> tab on the <code>Application</code> home page and click the <code>Register Device</code> button.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-6.png" alt=""></p> <p>In the <code>Register Device</code> panel, complete the forms for the <code>Device ID</code> and the <code>Device EUI</code>. The <code>Device ID</code> is user specified and is unique to the device in this application. The <code>Device EUI</code> is also user specified but must consist of exactly 8 bytes, given in hexadecimal.</p> <p>Once the device has been added, change the <code>Activation Method</code> between <code>OTAA</code> and <code>ABP</code> depending on user preference. This option can be found under the Settings tab.</p> <h3 id="adding-application-integrations">Adding Application Integrations</h3> <p>Now that the data is arriving on the TTN Backend, TTN can be managed as to where data should be delivered to. To do this, use the <code>Integrations</code> tab within the new Applications settings.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-7 (1).png" alt=""></p> <p>Upon clicking <code>add integration</code>, a screen with 4 different options will appear. These have various functionality and more information about them can be found on the TTN website/documentation.</p> <p>For this example, use the <code>HTTP Integration</code> to forward the LoRaWAN Packets to a remote server/address.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-8 (1).png" alt=""></p> <p>Click <code>HTTP Integration</code> to connect up an endpoint that can receive the data.</p> <p>For testing, a website called <a href="https://requestbin.com/">RequestBin</a>, may be used to receive the data that TTN forwards (via POST Request). To set this up, navigate to <a href="https://requestbin.com/">RequestBin</a> and click the <code>Create a RequestBin</code>.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-9 (1).png" alt=""></p> <p>Copy the URL that is generated and past this into the <code>URL</code> form under the <code>Application Settings</code>.</p> <p><img src="./LoRaWAN Nano-Gateway_files/ttn-10 (1).png" alt=""></p> <p>This is the address that TTN will forward data onto. As soon as a LoPy starts sending messages, TTN will forward these onto <code>RequestBin</code> and they will appear at the unique <code>RequestBin URL</code>.</p></div></div> <p>&nbsp;</p> <div class="layout full-width  prev-next pa-2 mt-4 mb-0 stylezz"><div class="flex ppurple xs6"><a href="https://docs.pycom.io/tutorials/lora/module-module/" class="ml-4 v-btn theme--light"><div class="v-btn__content">Previous</div></a></div> <div class="flex text-xs-right xs6"><a href="https://docs.pycom.io/tutorials/lora/rn2483-to-lopy/" class="mr-4 pbgpurple white--text v-btn theme--light"><div class="v-btn__content">Next</div></a></div></div> <div class="spacer"></div></div></div></div></main></div></div>

  <script src="./LoRaWAN Nano-Gateway_files/vue.js"></script>
  <script src="./LoRaWAN Nano-Gateway_files/vuetify.min.js"></script>
  <script src="./LoRaWAN Nano-Gateway_files/vue-resource.min.js"></script>
  <script type="text/javascript" src="./LoRaWAN Nano-Gateway_files/docsearch.min.js"></script>
  <script>
    var app = new Vue({
      el: '#app',
      data: {
        page: 1,
        pageCount: 0,
        error: null,
        results: null,
        drawer: true,
        drawer2: true,
        toc: 0,
        branches: [
          { value: 'https://docs.pycom.io', text: 'version stable',  },
          { value: 'https://development.pycom.io', text: 'version development'},
        ],
        branch: ""
      },
      mounted: function () {
        
        this.branch= this.branches[0]
        for (b in this.branches) {
          if ( document.location.href.indexOf(this.branches[b].value) > -1) {
            this.branch= this.branches[b]
          }
        }
        
        
        if (this.$refs.tocBtn) {
          var elem = this.$refs.tocBtn.$el
          setTimeout(function () {
              elem.click();

          }, 3500);
        }
        var elem2 = document.getElementById("vuetify-theme-stylesheet");
        elem2.parentNode.removeChild(elem2);

      },
      watch: {
        
        branch: function (newb, old) {
          if (newb.value != this.branches[0].value) {
            window.location = newb + window.location.pathname
          }
        },
      },
    });

    
    docsearch({
      apiKey: 'a99fde9999fbec81c1772eb9ffcca488',
      indexName: 'pycom',
      inputSelector: '.algolia-search-field input',
      debug: false 
    });
  </script><script type="text/javascript">
_atrk_opts = { atrk_acct:"WpWNq1SZw320l9", domain:"pycom.io",dynamic: true};
(function() { var as = document.createElement('script'); as.type = 'text/javascript'; as.async = true; as.src = "https://certify-js.alexametrics.com/atrk.js"; var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(as, s); })();
</script>
<noscript><img src="https://certify.alexametrics.com/atrk.gif?account=WpWNq1SZw320l9" style="display:none" height="1" width="1" alt="" /></noscript>


<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1216663,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-72107804-3', 'auto');
ga('send', 'pageview');
</script>


<iframe name="_hjRemoteVarsFrame" title="_hjRemoteVarsFrame" id="_hjRemoteVarsFrame" src="./LoRaWAN Nano-Gateway_files/box-469cf41adb11dc78be68c1ae7f9457a4.html" style="display: none !important; width: 1px !important; height: 1px !important; opacity: 0 !important; pointer-events: none !important;"></iframe></body></html>